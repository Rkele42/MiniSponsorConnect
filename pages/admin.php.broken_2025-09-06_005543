<?php
require_once __DIR__."/../app/db.php";
require_once __DIR__."/../app/helpers.php";

$pdo = rkd_pdo();
if (session_status()!==PHP_SESSION_ACTIVE) session_start();
$user = $_SESSION['user'] ?? null;
if (!$user) { header("Location:/?p=login"); exit; }

/* is_admin doğrula (oturumdaki cache yerine DB) */
$st=$pdo->prepare("SELECT is_admin FROM users WHERE id=?");
$st->execute([(int)$user['id']]);
if(!((int)($st->fetch()['is_admin']??0)===1)){ http_response_code(403); exit("Yetki yok"); }

/* yardımcılar */
function q($pdo,$sql,$args=[]){ $st=$pdo->prepare($sql); $st->execute($args); return $st; }
function kpi($pdo,$sql){ return (int)q($pdo,$sql)->fetchColumn(); }
function now(){ return rkd_now(); }

/* sekme */
$tab = $_GET['tab'] ?? 'dashboard';

/* site ayarlarını oku */
$settings=[];
foreach($pdo->query("SELECT key,value FROM site_settings") as $r){ $settings[$r['key']]=$r['value']; }

/* POST işlemleri (CSRF basit) */
$msg=null; $act=$_POST['action'] ?? null;

try{
  if($_SERVER['REQUEST_METHOD']==='POST'){
    switch($act){

      /* Ayarlar */
      case 'save_settings':
        $pairs = [
          'company_name' => trim($_POST['company_name'] ?? ''),
          'deposit_iban' => trim($_POST['deposit_iban'] ?? ''),
          'deposit_name' => trim($_POST['deposit_name'] ?? ''),
        ];
        foreach($pairs as $k=>$v){
          q($pdo,"INSERT INTO site_settings(key,value) VALUES(?,?) ON CONFLICT(key) DO UPDATE SET value=excluded.value",[$k,$v]);
          $settings[$k]=$v;
        }
        $msg="Ayarlar kaydedildi."; break;

      /* Topup (bakiye yükleme) */
      case 'approve_topup': {
        $id=(int)($_POST['id']??0);
        $t = q($pdo,"SELECT * FROM topups WHERE id=?",[$id])->fetch(PDO::FETCH_ASSOC);
        if($t && $t['status']==='pending'){
          add_balance($pdo,(int)$t['user_id'],(float)$t['amount']);
          q($pdo,"UPDATE topups SET status='approved', approved_at=?, admin_note=? WHERE id=?",[now(),trim($_POST['admin_note']??''),$id]);
          $msg="Yükleme onaylandı (#$id).";
        } break;
      }
      case 'reject_topup': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE topups SET status='rejected', approved_at=?, admin_note=? WHERE id=? AND status='pending'",[now(),trim($_POST['admin_note']??''),$id]);
        $msg="Yükleme reddedildi (#$id)."; break;
      }

      /* Withdrawals (çekim) */
      case 'wd_approve': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE withdrawals SET status='approved', updated_at=?, admin_note=? WHERE id=? AND status='pending'",[now(),trim($_POST['admin_note']??''),$id]);
        $msg="Çekim onaylandı (#$id)."; break;
      }
      case 'wd_mark_paid': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE withdrawals SET status='paid', updated_at=?, admin_note=? WHERE id=? AND status IN('approved','pending')",[now(),trim($_POST['admin_note']??''),$id]);
        $msg="Çekim ödendi olarak işaretlendi (#$id)."; break;
      }
      case 'wd_reject_refund': {
        $id=(int)($_POST['id']??0);
        $w=q($pdo,"SELECT * FROM withdrawals WHERE id=?",[$id])->fetch(PDO::FETCH_ASSOC);
        if($w && in_array($w['status'],['pending','approved'],true)){
          add_balance($pdo,(int)$w['user_id'], (float)$w['amount']+(float)$w['fee']);
          q($pdo,"UPDATE withdrawals SET status='rejected', updated_at=?, admin_note=? WHERE id=?",[now(),trim($_POST['admin_note']??''),$id]);
          $msg="Çekim reddedildi ve iade yapıldı (#$id).";
        } break;
      }

      /* Users */
      case 'user_toggle_admin': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE users SET is_admin=CASE WHEN is_admin=1 THEN 0 ELSE 1 END WHERE id=?",[$id]);
        $msg="Kullanıcı admin durumu değiştirildi (#$id)."; break;
      }
      case 'user_toggle_active': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE users SET is_active=CASE WHEN is_active=1 THEN 0 ELSE 1 END WHERE id=?",[$id]);
        $msg="Kullanıcı aktiflik durumu değiştirildi (#$id)."; break;
      }

      /* Listings */
      case 'listing_toggle_active': {
        $id=(int)($_POST['id']??0);
        q($pdo,"UPDATE listings SET is_active=CASE WHEN is_active=1 THEN 0 ELSE 1 END WHERE id=?",[$id]);
        $msg="İlan aktiflik durumu değiştirildi (#$id)."; break;
      }
      case 'listing_status': {
        $id=(int)($_POST['id']??0);
        $st = in_array(($_POST['status']??''),['active','hidden','sold','removed'],true) ? $_POST['status'] : 'active';
        q($pdo,"UPDATE listings SET status=? WHERE id=?",[$st,$id]);
        $msg="İlan durumu güncellendi (#$id → $st)."; break;
      }
      case 'listing_delete': {
        $id=(int)($_POST['id']??0);
        q($pdo,"DELETE FROM listings WHERE id=?",[$id]);
        $msg="İlan silindi (#$id)."; break;
      }
    }
  }
}catch(Throwable $e){ $msg="Hata: ".$e->getMessage(); }

/* KPI'lar */
$kpis = [
  'users'      => kpi($pdo,"SELECT COUNT(*) FROM users"),
  'users_act'  => kpi($pdo,"SELECT COUNT(*) FROM users WHERE is_active=1"),
  'listings'   => kpi($pdo,"SELECT COUNT(*) FROM listings"),
  'orders'     => kpi($pdo,"SELECT COUNT(*) FROM orders"),
  'top_pend'   => kpi($pdo,"SELECT COUNT(*) FROM topups WHERE status='pending'"),
  'wd_pend'    => kpi($pdo,"SELECT COUNT(*) FROM withdrawals WHERE status='pending'"),
];

/* veriler (sekmeye göre minimal sorgu) */
$users    = ($tab==='users') ? $pdo->query("SELECT id,username,is_admin,is_active,created_at FROM users ORDER BY id DESC LIMIT 100")->fetchAll() : [];
$listings = ($tab==='listings') ? $pdo->query("SELECT id,user_id,title,is_active,status FROM listings ORDER BY id DESC LIMIT 100")->fetchAll() : [];
$orders   = ($tab==='orders') ? $pdo->query("SELECT * FROM orders ORDER BY id DESC LIMIT 100")->fetchAll() : [];
$topups   = ($tab==='topups') ? $pdo->query("SELECT t.*,u.username FROM topups t JOIN users u ON u.id=t.user_id ORDER BY t.id DESC LIMIT 100")->fetchAll() : [];
$wds      = ($tab==='withdrawals') ? $pdo->query("SELECT w.*,u.username,p.iban,p.account_name
                                                  FROM withdrawals w
                                                  JOIN users u ON u.id=w.user_id
                                                  LEFT JOIN user_profiles p ON p.user_id=w.user_id
                                                  ORDER BY w.id DESC LIMIT 100")->fetchAll() : [];

require __DIR__."/../views/header.php";
?>
<div class="card">
  <h2>Admin Paneli</h2>
  <?php if($msg): ?><div class="alert"><?=htmlspecialchars($msg)?></div><?php endif; ?>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <span class="badge">Kullanıcı: <?=$kpis['users']?> (aktif <?=$kpis['users_act']?>)</span>
    <span class="badge">İlan: <?=$kpis['listings']?></span>
    <span class="badge">Sipariş: <?=$kpis['orders']?></span>
    <span class="badge">Bekleyen Yükleme: <?=$kpis['top_pend']?></span>
    <span class="badge">Bekleyen Çekim: <?=$kpis['wd_pend']?></span>
  </div>
</div>

<div class="card">
  <div class="row" style="gap:6px;flex-wrap:wrap">
    <?php
      $tabs = [
        'dashboard'=>'Gösterge',
        'settings'=>'Ayarlar',
        'users'=>'Kullanıcılar',
        'listings'=>'İlanlar',
        'orders'=>'Siparişler',
        'topups'=>'Yüklemeler',
        'withdrawals'=>'Çekimler',
      ];
      foreach($tabs as $k=>$v){
        $active = ($tab===$k) ? 'style="background:#0ea5e9;color:#001825"' : '';
        echo '<a class="btn" href="/?p=admin&tab='.htmlspecialchars($k).'" '.$active.'>'.htmlspecialchars($v).'</a>';
      }
    ?>
  </div>
</div>

<?php if($tab==='dashboard'): ?>
  <div class="card"><p class="help">Soldaki sekmelerden detaylara geçebilirsiniz.</p></div>

<?php elseif($tab==='settings'): ?>
  <div class="card">
    <h3 style="margin-top:0">Site Ayarları</h3>
    <form method="post" class="form-grid">
      <input type="hidden" name="action" value="save_settings">
      <div><label>Firma/Alıcı Adı</label><input name="company_name" value="<?=htmlspecialchars($settings['company_name'] ?? '')?>"></div>
      <div><label>Yatırım IBAN</label><input name="deposit_iban" value="<?=htmlspecialchars($settings['deposit_iban'] ?? '')?>"></div>
      <div><label>IBAN Sahibi</label><input name="deposit_name" value="<?=htmlspecialchars($settings['deposit_name'] ?? '')?>"></div>
      <div style="align-self:end"><button class="btn">Kaydet</button></div>
    </form>
  </div>

<?php elseif($tab==='users'): ?>
  <div class="card">
    <h3 style="margin-top:0">Kullanıcılar</h3>
    <?php foreach($users as $u): ?>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:.25rem 0">
        <span class="badge">#<?=$u['id']?></span>
        <span class="badge">@<?=htmlspecialchars($u['username'])?></span>
        <span class="badge">Admin: <?=((int)$u['is_admin']===1?'Evet':'Hayır')?></span>
        <span class="badge">Aktif: <?=((int)$u['is_active']===1?'Evet':'Hayır')?></span>
        <form method="post" class="row" style="gap:6px">
          <input type="hidden" name="id" value="<?=$u['id']?>">
          <button class="btn" name="action" value="user_toggle_admin">Admin Aç/Kapat</button>
          <button class="btn" name="action" value="user_toggle_active">Aktif Aç/Kapat</button>
        </form>
      </div>
      <div style="height:1px;background:#1f2937;margin:6px 0"></div>
    <?php endforeach; ?>
  </div>

<?php elseif($tab==='listings'): ?>
  <div class="card">
    <h3 style="margin-top:0">İlanlar</h3>
    <?php foreach($listings as $l): ?>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:.25rem 0">
        <span class="badge">#<?=$l['id']?></span>
        <span class="badge">user_id: <?=$l['user_id']?></span>
        <span class="badge"><?=htmlspecialchars($l['title'] ?? '(başlık)')?></span>
        <span class="badge">Aktif: <?=((int)$l['is_active']===1?'Evet':'Hayır')?></span>
        <span class="badge">Durum: <?=htmlspecialchars($l['status'])?></span>
        <form method="post" class="row" style="gap:6px">
          <input type="hidden" name="id" value="<?=$l['id']?>">
          <button class="btn" name="action" value="listing_toggle_active">Aktif Aç/Kapat</button>
          <select name="status">
            <?php foreach(['active'=>'Aktif','hidden'=>'Gizli','sold'=>'Satıldı','removed'=>'Kaldırıldı'] as $sk=>$sv): ?>
              <option value="<?=$sk?>" <?=$l['status']===$sk?'selected':''?>><?=$sv?></option>
            <?php endforeach; ?>
          </select>
          <button class="btn" name="action" value="listing_status">Durumu Kaydet</button>
          <button class="btn" name="action" value="listing_delete" style="background:#7f1d1d;color:#fecaca">Sil</button>
        </form>
      </div>
      <div style="height:1px;background:#1f2937;margin:6px 0"></div>
    <?php endforeach; ?>
  </div>

<?php elseif($tab==='orders'): ?>
  <div class="card">
    <h3 style="margin-top:0">Siparişler</h3>
    
<?php if (!function_exists("_order_amt")) {
  function _order_amt(array $o): float {
    foreach (["amount","total_amount","total_price","price","total","sum","amount_tl","price_tl"] as $k) {
      if (array_key_exists($k, $o) && $o[$k] !== null && $o[$k] !== "") {
        return (float)$o[$k];
      }
    }
    return 0.0;
  }
} ?>
<?php foreach($orders as $o): ?>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:.25rem 0">
        <span class="badge">#<?=$o['id']?></span>
        <span class="badge">Buyer: <?=$o['buyer_id']?></span>
        <span class="badge">Seller: <?=$o['seller_id']?></span>
        <span class="badge">Listing: <?=$o['listing_id']?></span>
        <span class="price"><?=number_format((float)_order_amt($o),2,',','.')?> TL</span>
        <span class="badge">Durum: <?=htmlspecialchars(strtr(,["pending"=>"Beklemede","approved"=>"Onaylandı","rejected"=>"Reddedildi","paid"=>"Ödendi"]))?></span>
      </div>
      <div style="height:1px;background:#1f2937;margin:6px 0"></div>
    <?php endforeach; ?>
  </div>

<?php elseif($tab==='topups'): ?>
  <div class="card">
    <h3 style="margin-top:0">Bakiye Yüklemeleri</h3>
    <?php foreach($topups as $t): ?>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:.25rem 0">
        <span class="badge">#<?=$t['id']?></span>
        <span class="badge">@<?=htmlspecialchars($t['username'])?></span>
        <span class="price"><?=number_format((float)$t['amount'],2,',','.')?> TL</span>
        <span class="badge">durum: <?=htmlspecialchars($t['status'])?></span>
      </div>
      <?php if($t['note']): ?><p class="help">Not: <?=htmlspecialchars($t['note'])?></p><?php endif; ?>
      <form method="post" class="row" style="gap:6px;margin:.25rem 0">
        <input type="hidden" name="id" value="<?=$t['id']?>">
        <input type="text" name="admin_note" placeholder="not (ops)">
        <?php if($t['status']==='pending'): ?>
          <button class="btn" name="action" value="approve_topup">Onayla</button>
          <button class="btn" name="action" value="reject_topup" style="background:#7f1d1d;color:#fecaca">Reddet</button>
        <?php endif; ?>
      </form>
      <div style="height:1px;background:#1f2937;margin:6px 0"></div>
    <?php endforeach; ?>
  </div>

<?php elseif($tab==='withdrawals'): ?>
  <div class="card">
    <h3 style="margin-top:0">Çekim Talepleri</h3>
    <?php foreach($wds as $w): ?>
      <?php
        $statusMap = [
          'pending'  => ['Beklemede',  'background:#f97316;color:#fff;'],
          'approved' => ['Onaylandı',  'background:#15803d;color:#fff;'],
          'rejected' => ['Reddedildi', 'background:#b91c1c;color:#fff;'],
          'paid'     => ['Ödendi',     'background:#6d28d9;color:#fff;'],
        ];
        $st=$w['status']; $text=$statusMap[$st][0]??$st; $style=$statusMap[$st][1]??'';
      ?>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:.25rem 0">
        <span class="badge">#<?=$w['id']?></span>
        <span class="badge">@<?=htmlspecialchars($w['username'])?></span>
        <span class="badge">IBAN: <?=htmlspecialchars($w['iban'] ?? '-')?></span>
        <span class="badge">Hesap: <?=htmlspecialchars($w['account_name'] ?? '-')?></span>
        <span class="price"><?=number_format((float)$w['amount'],2,',','.')?> TL</span>
        <span class="badge">komisyon: <?=number_format((float)$w['fee'],2,',','.')?> TL</span>
        <span class="badge" style="<?=$style?>">Durum: <?=htmlspecialchars($text)?></span>
      </div>
      <form method="post" class="row" style="gap:6px;margin:.25rem 0">
        <input type="hidden" name="id" value="<?=$w['id']?>">
        <input type="text" name="admin_note" placeholder="not (ops)">
        <?php if($w['status']==='pending'): ?>
          <button class="btn" name="action" value="wd_approve">Onayla</button>
          <button class="btn" name="action" value="wd_reject_refund" style="background:#7f1d1d;color:#fecaca">Reddet + İade</button>
        <?php elseif($w['status']==='approved'): ?>
          <button class="btn" name="action" value="wd_mark_paid">Ödendi</button>
          <button class="btn" name="action" value="wd_reject_refund" style="background:#7f1d1d;color:#fecaca">Reddet + İade</button>
        <?php endif; ?>
      </form>
      <div style="height:1px;background:#1f2937;margin:6px 0"></div>
    <?php endforeach; ?>
  </div>
<?php endif; ?>

<?php require __DIR__."/../views/footer.php"; ?>
